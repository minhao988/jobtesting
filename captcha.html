<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Canvas 拼圖滑塊 CAPTCHA</title>
<style>
body { font-family: Arial; text-align: center; margin-top: 50px; }
#captchaWrapper { position: relative; width: 300px; margin: 0 auto; }
#captchaCanvas { border-radius: 10px; }
#sliderContainer {
  width: 300px; height: 40px;
  background: #eee; margin: 20px auto; border-radius: 8px;
  position: relative;
}
#slider {
  width: 50px; height: 40px; background: #4CAF50;
  position: absolute; left: 0; top: 0; border-radius: 8px; cursor: pointer;
  transition: background 0.2s;
}
#slider.success { background: #2ecc71; }
#slider.failure { background: #e74c3c; }
#status { font-weight: bold; margin-top: 15px; }
</style>
</head>
<body>

<h2>請拖曳滑塊完成拼圖驗證</h2>

<div id="captchaWrapper">
  <canvas id="captchaCanvas" width="300" height="150"></canvas>
</div>

<div id="sliderContainer">
  <div id="slider"></div>
</div>

<p id="status"></p>

<script>
const canvas = document.getElementById("captchaCanvas");
const ctx = canvas.getContext("2d");
const slider = document.getElementById("slider");
const sliderContainer = document.getElementById("sliderContainer");
const status = document.getElementById("status");

let dragging = false;
let startX = 0;

// 背景圖片
const bg = new Image();
bg.src = "https://picsum.photos/300/150?random=" + Math.floor(Math.random() * 1000);

// 拼圖塊尺寸
const pieceSize = 50;
let pieceX, pieceY;

// 滑塊最大移動距離
const maxSliderX = sliderContainer.offsetWidth - slider.offsetWidth;

bg.onload = function() {
  pieceY = Math.floor(Math.random() * (canvas.height - pieceSize));
  pieceX = Math.floor(Math.random() * (canvas.width - pieceSize - pieceSize)); // 留空間給滑塊

  drawCaptcha();
};

// 畫 CAPTCHA
function drawCaptcha(sliderOffset=0) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 畫完整背景
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  // 挖出缺口
  ctx.save();
  ctx.globalCompositeOperation = "destination-out";
  ctx.fillStyle = "rgba(0,0,0,1)";
  ctx.fillRect(pieceX, pieceY, pieceSize, pieceSize);
  ctx.restore();

  // 畫滑塊拼圖塊
  ctx.drawImage(
    bg,
    pieceX, pieceY, pieceSize, pieceSize,
    sliderOffset, pieceY, pieceSize, pieceSize
  );
}

// 滑塊拖曳事件
slider.addEventListener("mousedown", e => {
  dragging = true;
  startX = e.clientX - slider.offsetLeft;
});

document.addEventListener("mouseup", e => {
  if (!dragging) return;
  dragging = false;

  const sliderLeft = parseInt(slider.style.left);
  const ratio = sliderLeft / maxSliderX;
  const piecePos = ratio * (canvas.width - pieceSize);

  if (Math.abs(piecePos - pieceX) < 10) {
    slider.style.left = maxSliderX + "px";
    slider.classList.add("success");
    status.textContent = "驗證成功！✅";
    status.style.color = "green";
  } else {
    slider.classList.add("failure");
    status.textContent = "驗證失敗，再試一次 ❌";
    status.style.color = "red";
    setTimeout(() => {
      slider.style.left = "0px";
      slider.classList.remove("failure");
      drawCaptcha(0);
    }, 800);
  }
});

document.addEventListener("mousemove", e => {
  if (!dragging) return;
  let x = e.clientX - startX;
  if (x < 0) x = 0;
  if (x > maxSliderX) x = maxSliderX;
  slider.style.left = x + "px";

  const ratio = x / maxSliderX;
  const sliderOffset = ratio * (canvas.width - pieceSize);
  drawCaptcha(sliderOffset);
});
</script>

</body>
</html>

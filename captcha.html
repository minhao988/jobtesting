<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>高級前端滑塊 CAPTCHA</title>
<style>
body { font-family: Arial; text-align: center; margin-top: 50px; }
#captchaWrapper { position: relative; width: 300px; margin: 0 auto; }
#captchaCanvas { border-radius: 10px; }
#sliderContainer {
  width: 300px; height: 40px;
  background: #eee; margin: 20px auto; border-radius: 8px;
  position: relative;
}
#slider {
  width: 50px; height: 40px; background: #4CAF50;
  position: absolute; left: 0; top: 0; border-radius: 8px; cursor: pointer;
  transition: background 0.2s;
}
#slider.success { background: #2ecc71; }
#slider.failure { background: #e74c3c; }
#status { font-weight: bold; margin-top: 15px; }
</style>
</head>
<body>

<h2>請拖曳滑塊完成拼圖驗證</h2>

<div id="captchaWrapper">
  <canvas id="captchaCanvas" width="300" height="150"></canvas>
</div>

<div id="sliderContainer">
  <div id="slider"></div>
</div>

<p id="status"></p>

<script>
const canvas = document.getElementById("captchaCanvas");
const ctx = canvas.getContext("2d");
const slider = document.getElementById("slider");
const sliderContainer = document.getElementById("sliderContainer");
const status = document.getElementById("status");

let dragging = false;
let startX = 0;
let trail = [];

// 背景圖片
const bg = new Image();
bg.src = "https://picsum.photos/300/150?random=" + Math.floor(Math.random() * 1000);

// 拼圖塊尺寸
const pieceSize = 50;
let pieceX, pieceY;

// 滑塊最大移動距離
const maxSliderX = sliderContainer.offsetWidth - slider.offsetWidth;

// 隨機生成不規則拼圖形狀
function drawPuzzleShape(ctx, x, y, size) {
  ctx.beginPath();
  const shapeType = Math.floor(Math.random()*3);
  if(shapeType===0){
    ctx.moveTo(x, y+size*0.2);
    ctx.bezierCurveTo(x+size*0.2,y-size*0.1,x+size*0.8,y+size*1.1,x+size,y+size*0.8);
    ctx.lineTo(x+size,y+size);
    ctx.lineTo(x,y+size);
  } else if(shapeType===1){
    ctx.moveTo(x+size*0.5,y);
    ctx.lineTo(x+size,y+size*0.2);
    ctx.lineTo(x+size*0.8,y+size);
    ctx.lineTo(x,y+size*0.8);
  } else {
    ctx.moveTo(x,y);
    ctx.lineTo(x+size*0.8,y);
    ctx.lineTo(x+size,y+size*0.8);
    ctx.lineTo(x+size*0.2,y+size);
  }
  ctx.closePath();
}

// 畫 CAPTCHA
bg.onload = function() {
  pieceY = Math.floor(Math.random() * (canvas.height - pieceSize));
  pieceX = Math.floor(Math.random() * (canvas.width - pieceSize - pieceSize));
  drawCaptcha(0);
};

function drawCaptcha(sliderOffset=0) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

  // 挖出不規則缺口
  ctx.save();
  ctx.globalCompositeOperation = "destination-out";
  drawPuzzleShape(ctx, pieceX, pieceY, pieceSize);
  ctx.fill();
  ctx.restore();

  // 畫滑塊拼圖
  ctx.save();
  drawPuzzleShape(ctx, sliderOffset, pieceY, pieceSize);
  ctx.clip();
  ctx.drawImage(bg, pieceX, pieceY, pieceSize, pieceSize, sliderOffset, pieceY, pieceSize, pieceSize);
  ctx.restore();
}

// 滑塊拖曳事件
slider.addEventListener("mousedown", e => {
  dragging = true;
  startX = e.clientX - slider.offsetLeft;
  trail = [];
});

document.addEventListener("mouseup", e => {
  if(!dragging) return;
  dragging = false;

  // 軌跡簡單檢測
  let validTrail = trail.length > 1 && Math.abs(trail[trail.length-1]-trail[0])>5;

  const sliderLeft = parseInt(slider.style.left);
  const ratio = sliderLeft / maxSliderX;
  const piecePos = ratio * (canvas.width - pieceSize);

  if(Math.abs(piecePos - pieceX)<10 && validTrail){
    slider.style.left = maxSliderX+"px";
    slider.classList.add("success");
    status.textContent = "驗證成功！✅";
    status.style.color="green";
  } else {
    slider.classList.add("failure");
    status.textContent="驗證失敗，再試一次 ❌";
    status.style.color="red";
    setTimeout(()=>{
      slider.style.left="0px";
      slider.classList.remove("failure");
      drawCaptcha(0);
    },800);
  }
});

document.addEventListener("mousemove", e => {
  if(!dragging) return;
  let x = e.clientX - startX;
  if(x<0) x=0;
  if(x>maxSliderX) x=maxSliderX;
  slider.style.left = x+"px";

  trail.push(x); // 記錄軌跡

  const ratio = x / maxSliderX;
  const sliderOffset = ratio * (canvas.width - pieceSize);
  drawCaptcha(sliderOffset);
});
</script>

</body>
</html>
